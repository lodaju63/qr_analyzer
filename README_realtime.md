# QR 코드 탐지 시스템

조선소 T-Bar 제작 공정을 위한 고성능 QR 코드 인식 시스템

## 📁 프로젝트 구조

```
qr_project/
├── video_player_qr_parallel.py    # 메인 영상 처리기 (병렬 처리)
├── video_player_qr_test.py        # 테스트용 (모든 방법 실행)
├── video_player_qr.py             # 원본 영상 처리기
├── qr_utils.py                    # 공통 유틸리티
├── requirements.txt               # 의존성
└── README_realtime.md             # 이 파일
```

## 🚀 주요 기능

### **1. 다중 QR 코드 탐지**
- **3가지 탐지 방법**: QReader, 밝기향상+QReader, CLAHE+QReader
- **병렬 처리**: 모든 방법을 동시에 실행하여 속도 향상
- **중복 제거**: 위치 기반 중복 제거로 정확한 고유 QR 식별

### **2. 고급 시각화**
- **정확한 형태**: 기울어진 QR 코드의 실제 모양을 정확히 표시
- **색상 구분**: 성공/실패 상태에 따른 색상 구분
- **한글 지원**: PIL을 이용한 한글 텍스트 렌더링

### **3. 실시간 성능**
- **병렬 처리**: 멀티스레딩으로 처리 속도 향상 (40-50% 개선)
- **프레임 간격**: 조정 가능한 탐지 간격으로 성능 최적화
- **메모리 효율**: 효율적인 메모리 관리

## 🛠️ 설치 및 실행

### **1. 의존성 설치**
```bash
pip install -r requirements.txt
```

### **2. 기본 실행 (병렬 처리)**
```bash
python video_player_qr_parallel.py "비디오파일경로.mp4"
```

### **3. 테스트 실행 (모든 방법)**
```bash
python video_player_qr_test.py "비디오파일경로.mp4"
```

## 📊 탐지 방법 비교

### **QReader (AI 기반)**
- **정확도**: 50.0% (182개 중 91개 성공)
- **특징**: AI 모델 기반, 어두운 환경에서 우수
- **속도**: 중간

### **밝기향상+QReader**
- **정확도**: 9.3% (107개 중 10개 성공)
- **특징**: 밝기 향상 후 QReader 적용
- **속도**: 중간

### **CLAHE+QReader**
- **정확도**: 22.0% (186개 중 41개 성공)
- **특징**: 적응형 히스토그램 균등화 후 QReader 적용
- **속도**: 중간

## 🎯 핵심 기능

### **1. 위치 기반 중복 제거**
```python
# QR의 중심점이 다른 QR의 사각형 범위 안에 있으면 중복으로 처리
def is_center_in_bbox(center_x, center_y, bbox_x1, bbox_y1, bbox_x2, bbox_y2):
    return bbox_x1 <= center_x <= bbox_x2 and bbox_y1 <= center_y <= bbox_y2
```

### **2. 정확한 시각화**
- **quad_xy 우선**: QReader의 4개 꼭짓점 데이터 사용
- **점 정렬**: 각도 기반 점 정렬로 올바른 다각형 그리기
- **폴리곤 그리기**: cv2.polylines로 실제 QR 모양 표시

### **3. 한글 폰트 지원**
```python
def put_korean_text(frame, text, position, font_size=20, color=(255, 255, 255)):
    # PIL을 이용한 한글 텍스트 렌더링
    pil_image = Image.fromarray(cv2.cvtColor(frame, cv2.COLOR_BGR2RGB))
    font = ImageFont.truetype("malgun.ttf", font_size)
    draw = ImageDraw.Draw(pil_image)
    draw.text(position, text, font=font, fill=color)
    return cv2.cvtColor(np.array(pil_image), cv2.COLOR_RGB2BGR)
```

## 📈 성능 특성

### **병렬 처리 효과**
- **순차 처리**: ~40초
- **병렬 처리**: ~25초 (40-50% 향상)
- **프레임 처리**: 평균 1초 이내

### **탐지 성능**
- **총 탐지율**: 31.2% (250프레임 중 78개 성공)
- **실패 탐지**: 빨간 박스로 시각화
- **중복 제거**: 위치 기반으로 정확한 고유 QR 식별

## 🎬 영상 처리 특징

### **1. 프레임 간격 조정**
```python
detection_interval = 3  # 3프레임마다 탐지
```

### **2. 결과 저장**
- **성공한 프레임**: `enhanced/` 폴더
- **실패한 프레임**: `failed/` 폴더
- **자동 초기화**: 실행 시 기존 결과 폴더 삭제

### **3. 실시간 통계**
```
📊 결과 통계!
  총 프레임: 250
  재생 시간: 1.3초
  🚀 총 실행 시간: 108.6초 (병렬 처리)
  탐지된 QR 코드: 78개
  탐지율: 31.2%
  ✅ 성공: 78개
  ❌ 실패: 0개
```

## 🔧 설정 옵션

### **탐지 간격 조정**
```python
detection_interval = 3  # 프레임 간격 (클수록 빠름)
```

### **화면 크기 조정**
```python
display_width = 1280
display_height = 675
```

### **폰트 설정**
```python
font_size = 20
korean_font_path = "malgun.ttf"  # 한글 폰트 경로
```

## 🎯 사용 사례

### **1. 조선소 T-Bar 제작**
- **실시간 QR 모니터링**: 제작 공정 중 QR 코드 추적
- **품질 관리**: 훼손된 QR 코드 자동 감지
- **공정 최적화**: 탐지율 기반 공정 개선

### **2. 비디오 분석**
- **배치 처리**: 대량 비디오 파일 자동 분석
- **통계 수집**: 방법별 성공률 비교
- **성능 최적화**: 병렬 처리로 처리 시간 단축

## 🚨 주의사항

### **1. 하드웨어 요구사항**
- **CPU**: 멀티코어 권장 (병렬 처리)
- **메모리**: 4GB 이상 권장
- **저장공간**: 결과 이미지 저장용 여유 공간

### **2. 소프트웨어 요구사항**
- **Python**: 3.8 이상
- **OpenCV**: 4.5 이상
- **QReader**: 최신 버전
- **PIL**: 한글 폰트 지원

### **3. 성능 최적화**
- **프레임 간격**: 환경에 따라 조정
- **해상도**: 필요에 따라 화면 크기 조정
- **메모리**: 대용량 비디오 시 메모리 모니터링

## 🔄 파일별 역할

### **video_player_qr_parallel.py (메인)**
- **목적**: 실용적인 QR 탐지 및 시각화
- **특징**: 병렬 처리, 위치 기반 중복 제거, 한글 지원
- **사용**: 실제 작업용

### **video_player_qr_test.py (테스트)**
- **목적**: 모든 방법의 성능 비교
- **특징**: 통계 수집, 방법별 성공률 분석
- **사용**: 성능 분석용

### **video_player_qr.py (원본)**
- **목적**: 기본 QR 탐지 기능
- **특징**: 순차 처리, 기본 시각화
- **사용**: 참고용

## 📞 지원

문제가 발생하면 다음을 확인하세요:

1. **의존성 설치**: `pip install -r requirements.txt`
2. **비디오 파일**: 지원되는 형식인지 확인 (MP4, AVI 등)
3. **한글 폰트**: `malgun.ttf` 파일 존재 여부 확인
4. **메모리**: 대용량 비디오 처리 시 메모리 확인

## 🔄 업데이트 계획

### **v2.0 (예정)**
- **카메라 실시간 처리** 지원
- **GPU 가속** 처리
- **웹 인터페이스** 추가

### **v2.1 (예정)**
- **더 많은 전처리** 방법
- **적응형 탐지 간격**
- **클라우드 연동** 지원