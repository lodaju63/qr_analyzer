name: Build Mac App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 수동 실행 가능

jobs:
  build-mac:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        
        # PyTorch CPU 버전 설치
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        
        # 나머지 패키지 설치
        pip install -r requirements_pyqt.txt
        pip install -r build_requirements.txt
    
    - name: Build Mac app
      run: |
        pyinstaller --clean qr_analyzer_onefile_mac.spec
    
    - name: Check build result
      run: |
        if [ -d "dist/QR_Analyzer.app" ]; then
          echo "✅ Build successful!"
          du -sh dist/QR_Analyzer.app
        else
          echo "❌ Build failed!"
          exit 1
        fi
    
    - name: Create DMG (optional)
      run: |
        hdiutil create -volname "QR Analyzer" \
          -srcfolder dist/QR_Analyzer.app \
          -ov -format UDZO \
          dist/QR_Analyzer.dmg
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: QR_Analyzer_Mac
        path: |
          dist/QR_Analyzer.app
          dist/QR_Analyzer.dmg
        retention-days: 7
